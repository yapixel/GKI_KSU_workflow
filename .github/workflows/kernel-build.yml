name: Build GKI Kernel with KernelSU and SuSFS

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: 5G
  CCACHE_NOHASHDIR: 1

jobs:
  build:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 90

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Build Environment (Arch Linux)
        run: |
          sudo pacman -Syu --noconfirm
          sudo pacman -S --noconfirm --needed base-devel
          
          # Install available packages
          sudo pacman -S --noconfirm --needed \
            bc bison flex openssl libelf ncurses \
            git wget curl lz4 zstd python3 python-pip \
            cpio kmod pahole pigz ninja rsync file
          
          # Install ccache from AUR if needed
          yay -S --noconfirm ccache patchelf xxd || true

      - name: Cache Toolchains and CCACHE
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/toolchain
            ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-toolchains-ccache-${{ github.ref }}-${{ hashFiles('.github/workflows/*.yml') }}-v8
          restore-keys: |
            ${{ runner.os }}-toolchains-ccache-${{ github.ref }}-
            ${{ runner.os }}-toolchains-ccache-
            ${{ runner.os }}-

      - name: Setup Custom Toolchain
        id: toolchain
        run: |
          set -e
          mkdir -p "${{ github.workspace }}/toolchain"
          cd "${{ github.workspace }}/toolchain"

          echo "üì• Downloading toolchains..."
          
          # Parallel download with retry logic
          download_with_retry() {
            local url="$1"
            local output="$2"
            local max_attempts=3
            
            for i in $(seq 1 $max_attempts); do
              if wget -q --show-progress -O "$output" "$url"; then
                echo "‚úÖ Downloaded $output"
                return 0
              fi
              echo "‚ö†Ô∏è Download attempt $i failed, retrying..."
              sleep 5
            done
            echo "‚ùå Failed to download $output after $max_attempts attempts"
            return 1
          }
          
          # Download GCC toolchains in parallel
          if [ ! -f "gcc-arm64.tar.xz" ]; then
            download_with_retry \
              "https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu.tar.xz" \
              "gcc-arm64.tar.xz" &
          fi

          if [ ! -f "gcc-arm32.tar.xz" ]; then
            download_with_retry \
              "https://developer.arm.com/-/media/Files/downloads/gnu/14.3.rel1/binrel/arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi.tar.xz" \
              "gcc-arm32.tar.xz" &
          fi

          # Download Clang
          if [ ! -f "clang.tar.gz" ]; then
            download_with_retry \
              "https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz" \
              "clang.tar.gz" &
          fi
          
          wait

          # Handle ZyCromerZ Clang extraction
          if [ ! -d "clang" ]; then
            echo "üì¶ Setting up ZyCromerZ Clang..."
            tar -xzf clang.tar.gz
            
            mkdir -p clang
            echo "Moving extracted files to clang/ directory..."
            
            for item in *; do
              if [ "$item" != "clang" ] && [ "$item" != "clang.tar.gz" ] && \
                 [ "$item" != "gcc-arm64.tar.xz" ] && [ "$item" != "gcc-arm32.tar.xz" ]; then
                mv "$item" clang/ 2>/dev/null || true
              fi
            done
            
            if [ ! -d "clang/bin" ]; then
              mkdir -p clang/bin
              find clang -maxdepth 1 -type f -executable -exec mv {} clang/bin/ \; 2>/dev/null || true
            fi
          fi

          echo "üì¶ Extracting GCC toolchains..."
          if [ ! -d "aarch64-gcc" ]; then
            tar -xf gcc-arm64.tar.xz &
          fi

          if [ ! -d "arm-gcc" ]; then
            tar -xf gcc-arm32.tar.xz &
          fi
          
          wait
          
          # Rename if needed
          [ -d "arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu" ] && \
            mv arm-gnu-toolchain-14.3.rel1-x86_64-aarch64-none-linux-gnu aarch64-gcc
          [ -d "arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi" ] && \
            mv arm-gnu-toolchain-14.3.rel1-x86_64-arm-none-eabi arm-gcc

          # Set paths
          CLANG_BIN="$PWD/clang/bin"
          
          if [ ! -d "$CLANG_BIN" ]; then
            CLANG_PATH=$(find clang -name "clang" -type f | head -1)
            if [ -n "$CLANG_PATH" ]; then
              CLANG_BIN=$(dirname "$CLANG_PATH")
            else
              CLANG_BIN="$PWD/clang"
            fi
          fi

          ARM64_TOOLCHAIN="$PWD/aarch64-gcc/bin/aarch64-none-linux-gnu-"
          ARM32_TOOLCHAIN="$PWD/arm-gcc/bin/arm-none-eabi-"

          # Verify toolchains
          if [ ! -f "$CLANG_BIN/clang" ]; then
            FOUND_CLANG=$(find clang -name "clang" -type f | head -1)
            if [ -n "$FOUND_CLANG" ]; then
              CLANG_BIN=$(dirname "$FOUND_CLANG")
            else
              echo "‚ùå Clang binary not found"
              exit 1
            fi
          fi

          for tool in "${ARM64_TOOLCHAIN}gcc" "${ARM32_TOOLCHAIN}gcc"; do
            if [ ! -f "$tool" ]; then
              echo "::error::Toolchain binary not found: $tool"
              exit 1
            fi
          done

          echo "CLANG_BIN=$CLANG_BIN" >> $GITHUB_ENV
          echo "ARM64_TOOLCHAIN=$ARM64_TOOLCHAIN" >> $GITHUB_ENV
          echo "ARM32_TOOLCHAIN=$ARM32_TOOLCHAIN" >> $GITHUB_ENV

          echo "‚úÖ Toolchain setup complete!"
          echo "clang: $("$CLANG_BIN/clang" --version | head -1)"
          echo "aarch64-gcc: $("${ARM64_TOOLCHAIN}gcc" --version | head -1)"
          echo "arm-gcc: $("${ARM32_TOOLCHAIN}gcc" --version | head -1)"

      - name: Setup ccache
        run: |
          mkdir -p ${{ env.CCACHE_DIR }}
          echo "$(dirname $(which ccache))" >> $GITHUB_PATH
          ccache --zero-stats
          ccache --show-config
          echo "üìä Initial CCACHE stats:"
          ccache --show-stats

      - name: Clone Kernel Source
        run: |
          if [ ! -d "kernel" ]; then
            for i in {1..3}; do
              if git clone --depth=1 --branch=android14-6.1-2025-09 \
                https://android.googlesource.com/kernel/common kernel; then
                echo "‚úÖ Kernel source cloned"
                break
              fi
              echo "‚ö†Ô∏è Clone attempt $i failed, retrying..."
              rm -rf kernel
              sleep 10
            done
          else
            cd kernel
            git fetch --depth=1 origin android14-6.1-2025-09
            git reset --hard origin/android14-6.1-2025-09
            cd ..
          fi

      - name: Patch setlocalversion Script
        run: |
          cd kernel
          sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion
          echo "‚úÖ setlocalversion patched to prevent dirty flag"

      - name: Integrate KernelSU
        run: |
          cd kernel
          for i in {1..3}; do
            if curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main; then
              echo "‚úÖ KernelSU integrated successfully"
              break
            fi
            echo "‚ö†Ô∏è KernelSU integration attempt $i failed, retrying..."
            sleep 10
          done

      - name: Clone and Integrate SuSFS
        run: |
          if [ ! -d "susfs" ]; then
            for i in {1..3}; do
              if git clone --depth=1 --branch=gki-android14-6.1 \
                https://gitlab.com/simonpunk/susfs4ksu.git susfs; then
                echo "‚úÖ SuSFS cloned"
                break
              fi
              echo "‚ö†Ô∏è Clone attempt $i failed, retrying..."
              rm -rf susfs
              sleep 10
            done
          fi
          cd kernel
          cp ../susfs/kernel_patches/fs/susfs.c fs/
          cp ../susfs/kernel_patches/include/linux/susfs.h include/linux/
          cp ../susfs/kernel_patches/include/linux/susfs_def.h include/linux/
          echo "‚úÖ SuSFS files integrated"

      - name: Apply All Patches
        id: patches
        run: |
          set +e
          cd kernel

          PATCH_BASE="https://raw.githubusercontent.com/infectedmushi/kernel_patches/refs/heads/main"

          apply_patch_with_retry() {
            local url="$1"
            local target_dir="$2"
            local name=$(basename "$url")
            
            cd "$target_dir"
            for i in {1..3}; do
              if curl -fsSL "$url" | patch -p1 --forward --no-backup-if-mismatch; then
                echo "‚úÖ Applied $name"
                cd "${{ github.workspace }}/kernel"
                return 0
              fi
              echo "‚ö†Ô∏è Patch $name attempt $i failed, retrying..."
              sleep 3
            done
            echo "‚ö†Ô∏è Patch $name may already be applied or failed"
            cd "${{ github.workspace }}/kernel"
            return 0
          }

          echo "üîß Applying patches..."
          
          apply_patch_with_retry "$PATCH_BASE/10_enable_susfs_for_ksu.patch" "KernelSU"
          apply_patch_with_retry "$PATCH_BASE/50_add_susfs_in_gki-android14-6.1.patch" "."
          apply_patch_with_retry "$PATCH_BASE/fix-clidr-uninitialized.patch" "."
          apply_patch_with_retry "$PATCH_BASE/fix_proc_base.patch" "."

          set -e
          echo "üéâ All patches applied!"

      - name: Configure Kernel
        id: config
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="$CLANG_BIN:$PATH"
          export CROSS_COMPILE="$ARM64_TOOLCHAIN"
          export CROSS_COMPILE_COMPAT="$ARM32_TOOLCHAIN"

          echo "‚öôÔ∏è Configuring kernel..."
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out gki_defconfig

          cat >> out/.config << 'EOF'
          CONFIG_ARM64_CORTEX_X3=y
          CONFIG_ARM64_CORTEX_A715=y
          CONFIG_ARM64_CORTEX_A510=y
          CONFIG_ARM64_VA_BITS=48
          CONFIG_ARM64_PA_BITS=48
          CONFIG_ARM64_TAGGED_ADDR_ABI=y
          CONFIG_ARM64_SVE=y
          CONFIG_ARM64_BTI=y
          CONFIG_ARM64_PTR_AUTH=y
          CONFIG_ARM64_SME=y
          CONFIG_SCHED_MC=y
          CONFIG_SCHED_CORE=y
          CONFIG_ENERGY_MODEL=y
          CONFIG_UCLAMP_TASK=y
          CONFIG_UCLAMP_TASK_GROUP=y
          CONFIG_CPU_FREQ=y
          CONFIG_CPUFREQ_DT=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_OPP=y
          CONFIG_CPU_IDLE=y
          CONFIG_ARM_PSCI_CPUIDLE=y
          CONFIG_THERMAL=y
          CONFIG_CPU_THERMAL=y
          CONFIG_DEVFREQ_THERMAL=y
          CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_THERMAL_GOV_FAIR_SHARE=y
          CONFIG_THERMAL_EMULATION=y
          CONFIG_THERMAL_WRITABLE_TRIPS=y
          CONFIG_POWER_CAP=y
          CONFIG_PERF_EVENTS=y
          CONFIG_NUMA_BALANCING=y
          CONFIG_CMA=y
          CONFIG_CMA_AREAS=7
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_KSU=y
          CONFIG_KSU_LSM_SECURITY_HOOKS=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y
          CONFIG_CCACHE=y
          CONFIG_LTO=y
          CONFIG_LTO_CLANG=y
          CONFIG_LTO_CLANG_THIN=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=256
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_LOCALVERSION="-deepongi"
          EOF

          rm -vf android/abi_gki_protected_exports_* || true
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 LD=ld.lld O=out olddefconfig

          echo "‚úÖ Kernel configured"
          grep -E "CONFIG_(KSU|SUSFS|LTO|LOCALVERSION)" out/.config | head -20

      - name: Build Kernel
        id: build
        continue-on-error: false
        run: |
          cd kernel
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="$CLANG_BIN:$PATH"
          export CROSS_COMPILE="$ARM64_TOOLCHAIN" 
          export CROSS_COMPILE_COMPAT="$ARM32_TOOLCHAIN"
          export KBUILD_BUILD_TIMESTAMP="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          export KBUILD_BUILD_USER=github-actions
          export KBUILD_BUILD_HOST=github
          
          # Dynamic core count
          NPROC=$(nproc || echo 8)

          echo "üèóÔ∏è Building kernel with $NPROC cores..."
          echo "üìä CCACHE stats before build:"
          ccache -s

          START_TIME=$SECONDS

          make -j"$NPROC" \
            LLVM_IAS=1 \
            LLVM=1 \
            ARCH=arm64 \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE_COMPAT="$ARM32_TOOLCHAIN" \
            CROSS_COMPILE="$ARM64_TOOLCHAIN" \
            CC="ccache clang" \
            LD=ld.lld \
            HOSTLD=ld.lld \
            O=out \
            2>&1 | tee build.log

          BUILD_STATUS=${PIPESTATUS[0]}
          BUILD_TIME=$((SECONDS - START_TIME))
          BUILD_TIME_MIN=$((BUILD_TIME / 60))
          BUILD_TIME_SEC=$((BUILD_TIME % 60))

          echo "üìä CCACHE stats after build:"
          ccache -s

          if [ $BUILD_STATUS -eq 0 ] && [ -f out/arch/arm64/boot/Image ]; then
            echo "‚úÖ Kernel built in ${BUILD_TIME_MIN}m ${BUILD_TIME_SEC}s"
            echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
            echo "BUILD_TIME_MIN=$BUILD_TIME_MIN" >> $GITHUB_ENV
            echo "BUILD_TIME_SEC=$BUILD_TIME_SEC" >> $GITHUB_ENV
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "‚ùå Build failed after ${BUILD_TIME_MIN}m ${BUILD_TIME_SEC}s"
            echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
            echo "BUILD_TIME_MIN=$BUILD_TIME_MIN" >> $GITHUB_ENV
            echo "BUILD_TIME_SEC=$BUILD_TIME_SEC" >> $GITHUB_ENV
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            exit 1
          fi

      - name: Upload Build Log on Failure
        if: failure() && steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs-${{ github.run_number }}
          path: |
            kernel/build.log
            kernel/out/.config
          retention-days: 30

      - name: Prepare AnyKernel3
        if: success()
        run: |
          for i in {1..3}; do
            if git clone --depth=1 --branch=KernelSU \
              https://github.com/deepongi-labs/AnyKernel3-p8a AnyKernel3; then
              break
            fi
            echo "‚ö†Ô∏è Clone attempt $i failed, retrying..."
            rm -rf AnyKernel3
            sleep 5
          done
          
          cd AnyKernel3
          rm -rf .git .github

          cp ../kernel/out/arch/arm64/boot/Image ./
          [ -f ../kernel/out/arch/arm64/boot/dtbo.img ] && cp ../kernel/out/arch/arm64/boot/dtbo.img ./
          [ -f ../kernel/out/arch/arm64/boot/dtb ] && cp ../kernel/out/arch/arm64/boot/dtb ./

          # Build metadata
          cat > build.info << EOF
          build.date=$(date -u +%Y-%m-%d)
          build.time=$(date -u +%H:%M:%S)
          build.commit=${{ github.sha }}
          build.run=${{ github.run_number }}
          build.duration=${{ env.BUILD_TIME }}s
          EOF

          echo "‚úÖ AnyKernel3 prepared"

      - name: Package Kernel
        if: success()
        run: |
          cd AnyKernel3
          KERNEL_VERSION="6.1.145"
          TIMESTAMP=$(date +%Y%m%d_%H%M)
          ZIP_NAME="GKI-KernelSU-SuSFS-${KERNEL_VERSION}-${TIMESTAMP}.zip"

          # Use pigz for parallel compression if available
          if command -v pigz &> /dev/null; then
            echo "Using pigz for faster compression..."
            tar cf - . -X <(echo ".git"; echo ".github"; echo "README.md") | pigz -9 > "../${ZIP_NAME%.zip}.tar.gz"
            # Convert to zip format for compatibility
            cd ..
            gunzip "${ZIP_NAME%.zip}.tar.gz"
            zip -r9 "$ZIP_NAME" AnyKernel3/* -x "*.git*" ".github/*" "README.md"
            rm -f "${ZIP_NAME%.zip}.tar"
          else
            zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" ".github/*"
            cd ..
          fi

          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"

          echo "KERNEL_ZIP=$ZIP_NAME" >> $GITHUB_ENV
          
          SIZE=$(du -h "$ZIP_NAME" | cut -f1)
          echo "üì¶ Package: $ZIP_NAME ($SIZE)"
          echo "üìÑ SHA256: $(cat ${ZIP_NAME}.sha256)"
          echo "üìÑ MD5: $(cat ${ZIP_NAME}.md5)"

      - name: Upload Kernel Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-${{ github.run_number }}
          path: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
          retention-days: 30

      - name: Create Release
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: "Kernel Build #${{ github.run_number }}"
          body: |
            ## üöÄ GKI Kernel with KernelSU & SuSFS
            
            **Build #${{ github.run_number }}** ‚Ä¢ $(date -u +%Y-%m-%d)
            
            ### üìä Build Info
            - **Duration:** ${{ env.BUILD_TIME_MIN }}m ${{ env.BUILD_TIME_SEC }}s
            - **Kernel:** 6.1.145-deepongi
            - **Branch:** android14-6.1-2025-09
            - **Commit:** ${{ github.sha }}
            
            ### üîß Components
            - ‚úÖ **KernelSU** (main branch)
            - ‚úÖ **SuSFS** (gki-android14-6.1)
            - ‚úÖ **Clang 22.0.0** (ZyCromerZ)
            - ‚úÖ **LTO:** ThinLTO
            
            ### üì• Installation
            1. Download the ZIP file
            2. Verify checksums (SHA256/MD5)
            3. Boot to recovery (TWRP/OrangeFox)
            4. Flash the ZIP
            5. Reboot
            
            ### üîê Checksums
            **SHA256:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.sha256)
            ```
            
            **MD5:**
            ```
            $(cat ${{ env.KERNEL_ZIP }}.md5)
            ```
          files: |
            ${{ env.KERNEL_ZIP }}
            ${{ env.KERNEL_ZIP }}.sha256
            ${{ env.KERNEL_ZIP }}.md5
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
