name: Test Telegram Notifications

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of notification to test'
        required: true
        default: 'success'
        type: choice
        options:
          - success
          - failure
          - custom
      custom_message:
        description: 'Custom message (if test_type is custom)'
        required: false
        default: 'This is a test message'
        type: string

jobs:
  test_notification:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Simulate Build Process
        run: |
          echo "ğŸ”§ Simulating build process..."
          sleep 2
          echo "âœ… Build simulation complete!"

      - name: Set Test Data
        id: test-data
        run: |
          # Simulate build data
          echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          echo "BUILD_DURATION=2m 15s" >> $GITHUB_ENV
          echo "KERNEL_VERSION=6.1.157" >> $GITHUB_ENV
          echo "CCACHE_HIT_RATE=93.5%" >> $GITHUB_ENV
          echo "CCACHE_HITS=131527" >> $GITHUB_ENV
          echo "CCACHE_MISSES=8236" >> $GITHUB_ENV
          echo "CCACHE_SIZE=34.2" >> $GITHUB_ENV
          echo "VARIANT_COUNT=5" >> $GITHUB_ENV
          echo "VARIANTS_FORMATTED=tiann | kowsu | mksu | sukisu | next" >> $GITHUB_ENV
          echo "SUSFS_STATUS=âœ… Enabled" >> $GITHUB_ENV
          echo "TIANN_KSU_VERSION=r43826" >> $GITHUB_ENV
          echo "KOWSU_KSU_VERSION=r43827" >> $GITHUB_ENV
          echo "MKSU_KSU_VERSION=r43828" >> $GITHUB_ENV
          echo "SUKISU_KSU_VERSION=r37185" >> $GITHUB_ENV
          echo "NEXT_KSU_VERSION=r43829" >> $GITHUB_ENV
          echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')" >> $GITHUB_ENV

      - name: Calculate CCache Emoji
        run: |
          # Simulate ccache emoji calculation
          HIT_RATE="93.5"
          RATE_NUM=$(echo "$HIT_RATE" | awk '{print int($1+0.5)}')
          
          if [ "$RATE_NUM" -ge 90 ]; then
            CCACHE_EMOJI="ğŸš€"
          elif [ "$RATE_NUM" -ge 70 ]; then
            CCACHE_EMOJI="âš¡"
          elif [ "$RATE_NUM" -ge 50 ]; then
            CCACHE_EMOJI="ğŸ“ˆ"
          elif [ "$RATE_NUM" -ge 20 ]; then
            CCACHE_EMOJI="ğŸ¢"
          else
            CCACHE_EMOJI="ğŸŒ"
          fi
          
          echo "CCACHE_EMOJI=$CCACHE_EMOJI" >> $GITHUB_ENV

      - name: Send Success Notification
        if: github.event.inputs.test_type == 'success'
        run: |
          CURRENT_TIME=$(date +"%H:%M")
          
          # Build KSU info
          KSU_INFO=""
          if [ -n "${{ env.TIANN_KSU_VERSION }}" ]; then
            KSU_INFO="âœ… *tiann:* ${{ env.TIANN_KSU_VERSION }}"
          fi
          if [ -n "${{ env.KOWSU_KSU_VERSION }}" ]; then
            if [ -n "$KSU_INFO" ]; then
              KSU_INFO="$KSU_INFO
          âœ… *kowsu:* ${{ env.KOWSU_KSU_VERSION }}"
            else
              KSU_INFO="âœ… *kowsu:* ${{ env.KOWSU_KSU_VERSION }}"
            fi
          fi
          if [ -n "${{ env.MKSU_KSU_VERSION }}" ]; then
            if [ -n "$KSU_INFO" ]; then
              KSU_INFO="$KSU_INFO
          âœ… *mksu:* ${{ env.MKSU_KSU_VERSION }}"
            else
              KSU_INFO="âœ… *mksu:* ${{ env.MKSU_KSU_VERSION }}"
            fi
          fi
          if [ -n "${{ env.SUKISU_KSU_VERSION }}" ]; then
            if [ -n "$KSU_INFO" ]; then
              KSU_INFO="$KSU_INFO
          âœ… *sukisu:* ${{ env.SUKISU_KSU_VERSION }}"
            else
              KSU_INFO="âœ… *sukisu:* ${{ env.SUKISU_KSU_VERSION }}"
            fi
          fi
          if [ -n "${{ env.NEXT_KSU_VERSION }}" ]; then
            if [ -n "$KSU_INFO" ]; then
              KSU_INFO="$KSU_INFO
          âœ… *next:* ${{ env.NEXT_KSU_VERSION }}"
            else
              KSU_INFO="âœ… *next:* ${{ env.NEXT_KSU_VERSION }}"
            fi
          fi
          
          # Format CCache details
          CCACHE_HITS="${{ env.CCACHE_HITS }}"
          CCACHE_MISSES="${{ env.CCACHE_MISSES }}"
          CCACHE_SIZE="${{ env.CCACHE_SIZE }}"
          
          CCACHE_DETAILS="${{ env.CCACHE_HIT_RATE }} (${CCACHE_HITS} hits, ${CCACHE_MISSES} misses)"
          
          MESSAGE="ğŸš€ *Build #${{ env.BUILD_NUMBER }} | SUCCESS* *(TEST)*
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ“¦ *Variants:* ${{ env.VARIANT_COUNT }}/5 (${{ env.VARIANTS_FORMATTED }})
          â±ï¸ *Duration:* ${{ env.BUILD_DURATION }}
          ğŸ›¡ï¸ *SuSFS:* ${{ env.SUSFS_STATUS }}
          ğŸ“± *Target:* Pixel 8a/8/8 Pro | Android 16 GKI
          
          ğŸ§¬ *Kernel Version:* ${{ env.KERNEL_VERSION }}
          ğŸ¯ *CCache Hit-Rate:* ${CCACHE_DETAILS} ${{ env.CCACHE_EMOJI }}
          ğŸ’¾ *Cache Size:* ${CCACHE_SIZE} GB
          
          ğŸ”§ *KSU Versions:*
          ${KSU_INFO}
          
          â¬‡ï¸ *Downloads:*
          [View Release](https://github.com/${{ github.repository }}/releases/tag/build-${{ env.BUILD_NUMBER }})
          
          ğŸ“ *Commit:* \`${{ env.COMMIT_HASH }}\` by ${{ env.COMMIT_AUTHOR }}
          ğŸ’¬ *Message:* \"${{ env.COMMIT_MESSAGE }}\"
          
          ğŸ”— *Links:*
          â”œâ”€ [Release Page](https://github.com/${{ github.repository }}/releases/tag/build-${{ env.BUILD_NUMBER }})
          â”œâ”€ [Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          â””â”€ [Download All](https://github.com/${{ github.repository }}/releases/tag/build-${{ env.BUILD_NUMBER }})
          
          ğŸ•°ï¸ ${CURRENT_TIME} | GitHub Actions"
          
          echo "Generated message:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$MESSAGE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Send with retry
          for ATTEMPT in 1 2 3; do
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="$MESSAGE" \
              -d parse_mode="Markdown" \
              -d disable_web_page_preview=true && echo "âœ… Sent!" && break
            [ $ATTEMPT -lt 3 ] && echo "âš ï¸ Retry $ATTEMPT..." && sleep $((ATTEMPT * 2))
          done

      - name: Send Failure Notification
        if: github.event.inputs.test_type == 'failure'
        run: |
          CURRENT_TIME=$(date +"%H:%M")
          
          MESSAGE="âŒ *Build #${{ env.BUILD_NUMBER }} | FAILED* *(TEST)*
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ”¨ *Failed Stage:* Build Process
          â±ï¸ *Duration:* ${{ env.BUILD_DURATION }}
          ğŸ“¦ *Target Variants:* ${{ env.VARIANTS_FORMATTED }}
          ğŸ›¡ï¸ *SuSFS:* ${{ env.SUSFS_STATUS }}
          
          ğŸ§¬ *Kernel Version:* ${{ env.KERNEL_VERSION }}
          ${{ env.CCACHE_EMOJI }} *CCache:* ${{ env.CCACHE_HIT_RATE }}
          
          ğŸš¨ *Error Details:*
          â€¢ Build process encountered an error
          â€¢ Check specific variant logs below
          â€¢ Last successful build: #$(({{ env.BUILD_NUMBER }} - 1))
          
          ğŸ”— *Quick Actions:*
          â”œâ”€ [View Error Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          â”œâ”€ [Retry This Build](https://github.com/${{ github.repository }}/actions/workflows/kernel-build.yml)
          â””â”€ [Compare with Previous](https://github.com/${{ github.repository }}/compare/build-$(({{ env.BUILD_NUMBER }} - 1))...build-${{ env.BUILD_NUMBER }})
          
          ğŸ“ *Commit:* \`${{ env.COMMIT_HASH }}\` by ${{ env.COMMIT_AUTHOR }}
          
          ğŸ•°ï¸ ${CURRENT_TIME} | GitHub Actions"
          
          echo "Generated failure message:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$MESSAGE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Send with retry
          for ATTEMPT in 1 2 3; do
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="$MESSAGE" \
              -d parse_mode="Markdown" \
              -d disable_web_page_preview=true && echo "âœ… Sent!" && break
            [ $ATTEMPT -lt 3 ] && echo "âš ï¸ Retry $ATTEMPT..." && sleep $((ATTEMPT * 2))
          done

      - name: Send Custom Notification
        if: github.event.inputs.test_type == 'custom'
        run: |
          CURRENT_TIME=$(date +"%H:%M")
          
          MESSAGE="ğŸ“¬ *Test Notification*
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          ${{ github.event.inputs.custom_message }}
          
          ğŸ”§ *Build Info:*
          â€¢ Build: #${{ env.BUILD_NUMBER }}
          â€¢ Kernel: ${{ env.KERNEL_VERSION }}
          â€¢ Variants: ${{ env.VARIANT_COUNT }}/5
          
          ğŸ“ *Commit:* \`${{ env.COMMIT_HASH }}\`
          
          ğŸ•°ï¸ ${CURRENT_TIME} | GitHub Actions"
          
          echo "Generated custom message:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "$MESSAGE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Send with retry
          for ATTEMPT in 1 2 3; do
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="$MESSAGE" \
              -d parse_mode="Markdown" \
              -d disable_web_page_preview=true && echo "âœ… Sent!" && break
            [ $ATTEMPT -lt 3 ] && echo "âš ï¸ Retry $ATTEMPT..." && sleep $((ATTEMPT * 2))
          done

      - name: Test Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š TELEGRAM NOTIFICATION TEST SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Test Type: ${{ github.event.inputs.test_type }}"
          echo "âœ… Build Number: ${{ env.BUILD_NUMBER }}"
          echo "âœ… Repository: ${{ github.repository }}"
          echo ""
          echo "Check your Telegram channel/group for the notification!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
